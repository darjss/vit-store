---

import PaymentStatus from "@/components/payment/payment-status";
import Layout from "@/layouts/Layout.astro";
import { createServerClient } from "@/lib/trpc";
import IconHome from "~icons/ri/home-4-line";
import IconMail from "~icons/ri/mail-line";
import IconMapPin from "~icons/ri/map-pin-line";
import IconPhone from "~icons/ri/phone-line";
import IconUser from "~icons/ri/user-line";

const { orderNumber } = Astro.params;
const cookieHeader = Astro.request.headers.get("cookie") || "";
const serverApi = createServerClient(cookieHeader, Astro.locals.runtime.env.server);
if(!orderNumber || orderNumber===undefined){
    return Astro.redirect("/404");
}
const order = await serverApi.order.getOrderByOrderNumber.query({ orderNumber: orderNumber });
console.log(order);
if(!order){
    return Astro.redirect("/404");
}

---

<Layout>
    <div class="container mx-auto px-4 py-8 min-h-screen">
        <PaymentStatus payment={order.payments[0]} client:load />

        <div class="max-w-4xl mx-auto mb-8">
            <div class="border-4 border-black bg-card shadow-[8px_8px_0_0_#000] transition-all">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-6 md:p-8 border-b-4 border-black">
                    <div>
                        <h2 class="text-2xl font-black uppercase tracking-tight mb-2">Захиалгын мэдээлэл</h2>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-muted-foreground">Захиалгын дугаар:</span>
                            <span class="font-mono font-bold text-lg">{orderNumber}</span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <div class="inline-flex items-center border-2 border-black px-3 py-1 text-xs font-black uppercase tracking-wide shadow-[2px_2px_0_0_#000] bg-success text-success-foreground">
                            {order?.status === 'pending' ? 'Хүлээгдэж буй' : order?.status === 'shipped' ? 'Илгээгдсэн' : order?.status === 'delivered' ? 'Хүргэгдсэн' : order?.status || 'Хүлээгдэж буй'}
                        </div>
                    </div>
                </div>
                
                <div class="p-6 md:p-8">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-black uppercase tracking-tight mb-3">Хүргэлтийн мэдээлэл</h3>
                            <div class="space-y-2">
                                <div class="flex items-start gap-3">
                                    <IconMapPin class="w-5 h-5 mt-0.5 flex-shrink-0" />
                                    <div>
                                        <p class="text-sm text-muted-foreground">Хүргэлтийн хаяг</p>
                                        <p class="font-medium">{order?.address}</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <IconPhone class="w-5 h-5 mt-0.5 flex-shrink-0" />
                                    <div>
                                        <p class="text-sm text-muted-foreground">Холбоо барих дугаар</p>
                                        <p class="font-medium">{order?.customerPhone}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-black uppercase tracking-tight mb-3">Захиалгын дүн</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-muted-foreground">Захиалсан огноо:</span>
                                    <span class="font-medium">{new Date(order?.createdAt || '').toLocaleDateString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-muted-foreground">Хүргэлтийн арга:</span>
                                    <span class="font-medium capitalize">{order?.deliveryProvider === 'tu-delivery' ? 'TU Delivery' : order?.deliveryProvider === 'self' ? 'Өөрөө авах' : order?.deliveryProvider?.replace('-', ' ') || 'TU Delivery'}</span>
                                </div>
                                {order?.notes && (
                                    <div class="flex justify-between">
                                        <span class="text-muted-foreground">Тэмдэглэл:</span>
                                        <span class="font-medium">{order.notes}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {order.orderDetails && order.orderDetails.length > 0 && (
            <div class="max-w-4xl mx-auto mb-8">
                <h2 class="text-2xl font-black uppercase tracking-tight mb-6">Захиалсан бүтээгдэхүүн</h2>
                <div class="space-y-4">
                    {order.orderDetails.map((detail) => (
                        <div class="border-4 border-black bg-card shadow-[6px_6px_0_0_#000] transition-all hover:shadow-[4px_4px_0_0_#000] hover:translate-x-[2px] hover:translate-y-[2px]">
                            <div class="p-6 flex flex-col md:flex-row gap-6">
                                <div class="flex-shrink-0">
                                    <img 
                                        src={detail.product.images[0]?.url || '/placeholder-product.png'} 
                                        alt={detail.product.name}
                                        class="w-24 h-24 object-cover border-2 border-black"
                                    />
                                </div>
                                <div class="flex-grow">
                                    <h3 class="font-black text-lg uppercase tracking-tight mb-1">{detail.product.name}</h3>
                                    <p class="text-sm text-muted-foreground mb-3">{detail.product.brand.name}</p>
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-4">
                                            <span class="text-sm text-muted-foreground">Тоо хэмжээ:</span>
                                            <span class="font-bold">{detail.quantity}</span>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-muted-foreground">Үнэ</p>
                                            <p class="font-black text-lg">₮{detail.product.price.toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        <div class="max-w-4xl mx-auto mb-12">
            <div class="border-4 border-black bg-primary text-primary-foreground shadow-[8px_8px_0_0_#000] p-6 md:p-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-black uppercase tracking-tight">Нийт дүн</h3>
                        <p class="text-sm opacity-90">Татвар, шимтгэл багтсан</p>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-black">₮{(order?.total || 0).toLocaleString()}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a 
                    href="/"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-black uppercase tracking-wide transition-all focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:cursor-not-allowed border-3 border-black bg-white text-black shadow-[6px_6px_0_0_#000] hover:shadow-[3px_3px_0_0_#000] hover:translate-x-[3px] hover:translate-y-[3px] active:shadow-none h-12 md:h-14 px-6 md:px-8 py-3 text-sm md:text-base"
                >
                    <IconHome class="w-4 h-4" />
                    Худалдан авалтыг үргэлжлүүлэх
                </a>
                <a 
                    href="/profile"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-black uppercase tracking-wide transition-all focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:cursor-not-allowed border-3 border-black bg-primary text-primary-foreground shadow-[6px_6px_0_0_#000] hover:shadow-[3px_3px_0_0_#000] hover:translate-x-[3px] hover:translate-y-[3px] active:shadow-none h-12 md:h-14 px-6 md:px-8 py-3 text-sm md:text-base"
                >
                    <IconUser class="w-4 h-4" />
                    Миний захиалгууд
                </a>
            </div>
        </div>

        <!-- Help Section -->
        <div class="max-w-4xl mx-auto mt-16 text-center">
            <div class="border-4 border-black bg-secondary p-8 shadow-[6px_6px_0_0_#fff]">
                <h3 class="text-xl font-black uppercase tracking-tight mb-4">Тусламж хэрэгтэй юу?</h3>
                <p class="text-muted-foreground mb-6">Хэрэв таны захиалгатай холбоотой асуулт байвал бидэнтэй холбогдоорой.</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a 
                        href="tel:+97600000000"
                        class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-black uppercase tracking-wide transition-all focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:cursor-not-allowed border-3 border-black bg-white text-black shadow-[6px_6px_0_0_#000] hover:shadow-[3px_3px_0_0_#000] hover:translate-x-[3px] hover:translate-y-[3px] active:shadow-none h-12 px-6 py-3 text-sm"
                    >
                        <IconPhone class="w-4 h-4" />
                        Утсаар залгах
                    </a>
                    <a 
                        href="mailto:support@example.com"
                        class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-black uppercase tracking-wide transition-all focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:cursor-not-allowed border-3 border-black bg-white text-black shadow-[6px_6px_0_0_#000] hover:shadow-[3px_3px_0_0_#000] hover:translate-x-[3px] hover:translate-y-[3px] active:shadow-none h-12 px-6 py-3 text-sm"
                    >
                        <IconMail class="w-4 h-4" />
                        Имэйл илгээх
                    </a>
                </div>
            </div>
        </div>
    </div>
</Layout>