---
import AddToCartButton from "@/components/cart/add-to-cart-button";
import Layout from "@/layouts/Layout.astro";
import { productColors } from "@/lib/constant";
import { api } from "@/lib/trpc";
import type { ProductForHome } from "@/lib/types";
import { formatCurrency } from "@/lib/utils";

export const prerender = true;

const products = await api.product.getProductsForHome.query();
const { featuredProducts, newProducts } = products;
const brands = await api.brand.getAllBrands.query();
const allCategories = await api.category.getAllCategories.query();

const topBrands = brands.slice(0, 8) as Array<{ name: string }>;

const preferredCategoryNames = [
  "Дархлаа", "Гоо сайхан", "Энерги", "Яс үе мөч",
  "Зүрх судас", "Ходоод гэдэс", "Нойр", "Тархи мэдрэл",
];
const orderedCategories = [
  ...preferredCategoryNames
    .map((name) => allCategories.find((c: { id: number; name: string }) => c.name === name))
    .filter(Boolean),
  ...allCategories.filter(
    (c: { id: number; name: string }) => !preferredCategoryNames.includes(c.name),
  ),
];
const categoriesForPills = orderedCategories.slice(0, 10) as Array<{ id: number; name: string }>;
---

<Layout title="Amerikvitamin — Витамин хэрэг болвол бид энд">
  <!-- V4: TYPE WALL — Large brand typography, thick category tabs, dense products -->

  <!-- Hero bar -->
  <section class="border-b-2 border-border bg-foreground text-background">
    <div class="px-5 py-5 lg:px-8 lg:py-8 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div>
        <h1 class="text-xl md:text-2xl lg:text-3xl font-black uppercase tracking-tighter">
          Витамин хэрэг болвол <span class="text-primary">бид энд.</span>
        </h1>
        <p class="text-[11px] md:text-sm font-medium text-background/50 mt-1">АНУ-аас авчирна. Хурдан хүргэнэ. Энгийн.</p>
      </div>
      <a href="/products" class="self-start lg:self-center flex-none px-6 py-2.5 bg-primary text-foreground font-bold text-[12px] uppercase tracking-wider border-2 border-primary active:scale-[0.97] transition-transform">
        Бараа харах
      </a>
    </div>
  </section>

  <!-- BRANDS: Large stacked typography wall, dark bg -->
  <section class="border-b-2 border-border bg-foreground">
    <div class="px-5 py-5 lg:px-8 lg:py-8">
      <div class="text-[9px] font-bold uppercase tracking-[0.3em] text-background/30 mb-3">Брэндүүд</div>
      <div class="flex flex-wrap gap-x-5 gap-y-1 lg:gap-x-8 lg:gap-y-2">
        {topBrands.map((brand) => (
          <span class="text-2xl md:text-3xl lg:text-4xl font-black uppercase tracking-tighter text-background/60">{brand.name}</span>
        ))}
      </div>
    </div>
  </section>

  <!-- CATEGORIES: Thick horizontal tabs with borders -->
  <section class="border-b-2 border-border">
    <div class="flex gap-0 overflow-x-auto scrollbar-hide">
      {categoriesForPills.map((cat, i: number) => (
        <a
          href={`/products?category=${cat.id}`}
          class={`flex-none px-4 py-3 lg:px-5 lg:py-4 font-bold text-[11px] md:text-xs uppercase tracking-tight active:bg-foreground active:text-background transition-colors ${
            i < categoriesForPills.length - 1 ? 'border-r-2 border-border' : ''
          }`}
        >
          {cat.name}
        </a>
      ))}
    </div>
  </section>

  <!-- Featured: dense grid -->
  <section class="border-b-2 border-border">
    <div class="px-3 pt-6 pb-8 lg:px-6 lg:py-12">
      <div class="flex items-center justify-between mb-4 px-2">
        <h2 class="text-lg md:text-2xl font-black uppercase tracking-tight">Хүмүүсийн дуртай</h2>
        <a href="/products?filter=featured" class="text-[10px] font-bold uppercase tracking-wider text-muted-foreground active:text-foreground">Бүгд →</a>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 lg:gap-2.5">
        {featuredProducts.map((p: ProductForHome) => (
          <div class="group border-2 border-border bg-card active:shadow-hard-sm transition-all">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-3 lg:p-4" width="300" height="300" loading="eager" />}
              </div>
            </a>
            <div class="p-2">
              <div class="text-[7px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <a href={`/products/${p.slug}-${p.id}`}><h3 class="text-[10px] md:text-[11px] font-bold line-clamp-1 mt-0.5 leading-tight">{p.name}</h3></a>
              <div class="flex items-center justify-between mt-1.5 pt-1.5 border-t-2 border-border">
                <span class="font-black text-[12px]">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- New arrivals: horizontal cards for variety -->
  <section class="border-b-2 border-border">
    <div class="px-3 pt-6 pb-8 lg:px-6 lg:py-12">
      <div class="flex items-center justify-between mb-4 px-2">
        <h2 class="text-lg md:text-2xl font-black uppercase tracking-tight">Дөнгөж ирсэн</h2>
        <a href="/products?filter=recent" class="text-[10px] font-bold uppercase tracking-wider text-muted-foreground active:text-foreground">Бүгд →</a>
      </div>
      <div class="space-y-2 lg:grid lg:grid-cols-2 lg:gap-2.5 lg:space-y-0">
        {newProducts.slice(0, 6).map((p: ProductForHome) => (
          <div class="border-2 border-border bg-card active:shadow-hard-sm transition-all">
            <div class="flex">
              <a href={`/products/${p.slug}-${p.id}`} class="block flex-none w-[90px] md:w-[110px] lg:w-[120px]">
                <div class="relative aspect-square overflow-hidden border-r-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                  {p.image && <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-2 lg:p-3" width="120" height="120" loading="lazy" />}
                </div>
              </a>
              <div class="flex-1 p-2 lg:p-3 flex flex-col justify-between min-w-0">
                <div>
                  <div class="text-[7px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
                  <a href={`/products/${p.slug}-${p.id}`}><h3 class="text-[10px] md:text-xs font-bold line-clamp-2 mt-0.5 leading-tight">{p.name}</h3></a>
                </div>
                <div class="flex items-center justify-between mt-1.5 pt-1.5 border-t-2 border-border">
                  <span class="font-black text-[12px]">{formatCurrency(p.price)}</span>
                  <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Trust -->
  <section class="border-b-2 border-border bg-foreground text-background">
    <div class="grid grid-cols-2 lg:grid-cols-4 divide-x-2 divide-background/10">
      {[
        { val: "100%", label: "Оригинал" },
        { val: "FDA", label: "Баталгаатай" },
        { val: "24ц", label: "Хүргэнэ" },
        { val: "14 хоног", label: "Буцаана" },
      ].map((s) => (
        <div class="px-4 py-4 lg:py-5 text-center">
          <div class="font-black text-lg text-primary">{s.val}</div>
          <div class="text-[8px] font-bold uppercase tracking-widest text-background/40">{s.label}</div>
        </div>
      ))}
    </div>
  </section>

  <!-- CTA -->
  <section class="px-3 py-8 lg:px-6 lg:py-14">
    <div class="border-3 border-border bg-primary p-5 lg:p-10 shadow-hard-lg relative overflow-hidden">
      <div class="absolute inset-0 bg-grid-pattern opacity-[0.08] pointer-events-none"></div>
      <div class="relative z-10 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 class="text-xl md:text-3xl font-black uppercase tracking-tight">Дэлгүүрээ тойрох уу?</h2>
          <p class="text-[12px] md:text-sm font-medium text-foreground/70 mt-1">200 гаруй бүтээгдэхүүн, бүгд хүргэлттэй.</p>
        </div>
        <a href="/products" class="self-start lg:self-center flex-none px-8 py-3.5 bg-foreground text-background font-black text-[13px] uppercase tracking-wider border-2 border-foreground active:scale-[0.97] transition-transform">Харах</a>
      </div>
    </div>
  </section>
</Layout>
