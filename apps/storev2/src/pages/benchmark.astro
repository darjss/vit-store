---
import BenchmarkComparison from "../components/benchmark-comparison.tsx";
import Layout from "../layouts/Layout.astro";
import { createServerClient } from "../lib/trpc";

// Force dynamic rendering
export const prerender = false;

const serverStartTime = performance.now();
const serverApi = createServerClient("cookieHeader", Astro.locals.runtime.env.server);
const serverData = await serverApi.product.getProductBenchmark.query();
const serverEndTime = performance.now();
const serverFetchTime = serverEndTime - serverStartTime;

const formatTime = (ms: number) => `${ms.toFixed(2)}ms`;
---

<Layout title="Benchmark - Server vs Client Fetch">
	<div class="container mx-auto px-4 py-8">
		<h1 class="text-4xl font-bold mb-8 text-center">Performance Benchmark</h1>
		<p class="text-center text-gray-600 mb-8">
			Comparing server-side rendering vs client-side fetching performance
		</p>
		
		<div class="mx-auto max-w-4xl space-y-6">
			<!-- Server-Side Results (Static) -->
			<div class="rounded-lg border-2 border-green-300 bg-gradient-to-br from-green-50 to-green-100 p-6 shadow-md">
				<div class="mb-4 flex items-center gap-2">
					<svg
						class="h-6 w-6 text-green-600"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"
						/>
					</svg>
					<h2 class="font-bold text-2xl text-green-800">Server-Side (SSR)</h2>
				</div>

				<div class="space-y-3">
					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Total Fetch Time</p>
						<p class="font-bold text-3xl text-green-700">
							{formatTime(serverFetchTime)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Database Query Time</p>
						<p class="font-semibold text-2xl text-green-600">
							{formatTime(serverData.dbElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">KV Write Time</p>
						<p class="font-semibold text-2xl text-green-600">
							{formatTime(serverData.kvWriteElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">KV Read Time</p>
						<p class="font-semibold text-2xl text-green-600">
							{formatTime(serverData.kvReadElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Products Fetched</p>
						<p class="font-semibold text-2xl text-green-600">
							{serverData.product.length}
						</p>
					</div>
				</div>

				<div class="mt-4 rounded-lg bg-green-200 p-3">
					<p class="font-medium text-green-800 text-sm">
						âœ“ Rendered on server
					</p>
					<p class="mt-1 text-green-700 text-xs">
						No client-side JavaScript required for initial render
					</p>
				</div>
			</div>

			<!-- Client-Side Results (Interactive) -->
			<BenchmarkComparison 
				client:only="solidjs"
				serverFetchTime={serverFetchTime}
				serverDbTime={serverData.dbElapsed}
				productCount={serverData.product.length}
				kvWriteTime={serverData.kvWriteElapsed}
				kvReadTime={serverData.kvReadElapsed}
			/>
		</div>
	</div>
</Layout>
