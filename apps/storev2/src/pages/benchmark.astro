---

import BenchmarkComparison from "@/components/benchmark-comparison";
import Layout from "@/layouts/Layout.astro";
import IconCheck from "~icons/ri/check-line";
import IconServer from "~icons/ri/server-line";
import { createServerClient } from "../lib/trpc";

// Force dynamic rendering
export const prerender = false;

const serverStartTime = performance.now();
const serverApi = createServerClient("cookieHeader", Astro.locals.runtime.env.server);
const serverData = await serverApi.product.getProductBenchmark.query();
const serverEndTime = performance.now();
const serverFetchTime = serverEndTime - serverStartTime;

const formatTime = (ms: number) => `${ms.toFixed(2)}ms`;
---

<Layout title="Benchmark - Server vs Client Fetch">
	<div class="container mx-auto px-4 py-8">
		<h1 class="text-4xl font-bold mb-8 text-center">Performance Benchmark</h1>
		<p class="text-center text-gray-600 mb-8">
			Comparing server-side rendering vs client-side fetching performance
		</p>
		
		<div class="mx-auto max-w-4xl space-y-6">
			<!-- Server-Side Results (Static) -->
			<div class="rounded-lg border-2 border-green-300 bg-gradient-to-br from-green-50 to-green-100 p-6 shadow-md">
				<div class="mb-4 flex items-center gap-2">
					<IconServer class="h-6 w-6 text-green-600" />
					<h2 class="font-bold text-2xl text-green-800">Server-Side (SSR)</h2>
				</div>

				<div class="space-y-3">
					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Total Fetch Time</p>
						<p class="font-bold text-3xl text-green-700">
							{formatTime(serverFetchTime)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Database Query Time</p>
						<p class="font-semibold text-2xl text-green-600">
							{formatTime(serverData.dbElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">KV Write Time</p>
						<p class="font-semibold text-2xl text-green-600">
							{formatTime(serverData.kvWriteElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">KV Read Time</p>
						<p class="font-semibold text-2xl text-green-600">
							{formatTime(serverData.kvReadElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Redis Write Time</p>
						<p class="font-semibold text-2xl text-orange-600">
							{formatTime(serverData.redisWriteElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Redis Read Time</p>
						<p class="font-semibold text-2xl text-orange-600">
							{formatTime(serverData.redisReadElapsed)}
						</p>
					</div>

					<div class="rounded-lg bg-white p-4">
						<p class="mb-1 text-gray-600 text-sm">Products Fetched</p>
						<p class="font-semibold text-2xl text-green-600">
							{serverData.product.length}
						</p>
					</div>
				</div>

				<div class="mt-4 rounded-lg bg-green-200 p-3">
					<p class="font-medium text-green-800 text-sm flex items-center gap-1">
						<IconCheck class="h-4 w-4" /> Rendered on server
					</p>
					<p class="mt-1 text-green-700 text-xs">
						No client-side JavaScript required for initial render
					</p>
				</div>
			</div>

			<!-- Client-Side Results (Interactive) -->
			<BenchmarkComparison 
				client:only="solidjs"
				serverFetchTime={serverFetchTime}
				serverDbTime={serverData.dbElapsed}
				productCount={serverData.product.length}
				kvWriteTime={serverData.kvWriteElapsed}
				kvReadTime={serverData.kvReadElapsed}
				redisWriteTime={serverData.redisWriteElapsed}
				redisReadTime={serverData.redisReadElapsed}
			/>
		</div>
	</div>
</Layout>
