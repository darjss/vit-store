---



import AddToCartButton from "@/components/cart/add-to-cart-button";
import Layout from "@/layouts/Layout.astro";
import { productColors } from "@/lib/constant";
import { api } from "@/lib/trpc";
import type { ProductForHome } from "@/lib/types";
import { formatCurrency } from "@/lib/utils";

export const prerender = true;

const products = await api.product.getProductsForHome.query();
const { featuredProducts, newProducts, discountedProducts } = products;
const brands = await api.brand.getAllBrands.query();
const allCategories = await api.category.getAllCategories.query();

const preferredCategoryNames = [
  "Дархлаа",
  "Гоо сайхан",
  "Энерги",
  "Яс үе мөч",
  "Зүрх судас",
  "Ходоод гэдэс",
  "Нойр",
  "Тархи мэдрэл",
];

const orderedCategories = [
  ...preferredCategoryNames
    .map((name) => allCategories.find((c: { id: number; name: string }) => c.name === name))
    .filter(Boolean),
  ...allCategories.filter(
    (c: { id: number; name: string }) => !preferredCategoryNames.includes(c.name),
  ),
];

const categoriesForPills = orderedCategories.slice(0, 10) as Array<{
  id: number;
  name: string;
}>;
---

<Layout>
  <!-- DESIGN 4 v2: "SPLIT EDITORIAL" — Mobile-first rewrite -->
  <!-- 99% mobile traffic. Every section designed for thumb-scrolling first. -->

  <!-- ==================== HERO ==================== -->
  <section class="border-b-2 border-border">
    <!-- Mobile: stacked. Desktop: split -->
    <div class="grid lg:grid-cols-2">
      <!-- Text -->
      <div class="px-5 pt-8 pb-6 lg:px-14 lg:py-28 lg:border-r-2 border-border flex flex-col justify-center">
        <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-muted-foreground mb-3">amerikvitamin.mn</span>
        <h1 class="text-[32px] leading-[0.95] md:text-5xl lg:text-6xl font-black uppercase tracking-tighter mb-4">
          Америк витамин,<br/>
          <span class="text-primary">шууд танд.</span>
        </h1>
        <p class="text-[13px] md:text-base font-medium text-muted-foreground leading-relaxed mb-6 max-w-md">
          АНУ-ын эмийн сангаас зардаг тэр витаминууд — одоо Монголдоо хүргэлттэй.
        </p>

        <!-- Trust row — compact on mobile -->
        <div class="flex gap-3 mb-6 overflow-x-auto scrollbar-hide -mx-5 px-5 pb-1">
          {[
            { val: "100%", label: "Оригинал" },
            { val: "FDA", label: "Баталгаат" },
            { val: "24ц", label: "Хүргэлт" },
          ].map((s) => (
            <div class="flex-none flex items-center gap-1.5 px-3 py-1.5 border-2 border-border bg-muted/30">
              <span class="font-black text-sm">{s.val}</span>
              <span class="text-[8px] font-bold uppercase tracking-wider text-muted-foreground">{s.label}</span>
            </div>
          ))}
        </div>

        <a href="/products" class="self-start px-7 py-3 bg-foreground text-background font-bold text-[13px] uppercase tracking-wider border-2 border-foreground active:scale-[0.97] transition-transform">
          Бүтээгдэхүүн үзэх
        </a>
      </div>

      <!-- Hero products: 2x2 grid, always visible -->
      <div class="grid grid-cols-2 border-t-2 lg:border-t-0 border-border">
        {featuredProducts.slice(0, 4).map((p: ProductForHome, i: number) => (
          <a href={`/products/${p.slug}-${p.id}`} class={`group relative block overflow-hidden ${i < 2 ? 'border-b-2 border-border' : ''} ${i % 2 === 0 ? 'border-r-2 border-border' : ''}`}>
            <div class="relative aspect-square overflow-hidden" style={`background: ${productColors[p.id % productColors.length]}`}>
              {p.image && (
                <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-5 md:p-6 group-hover:scale-105 transition-transform duration-500" width="400" height="400" loading="eager" />
              )}
            </div>
            <!-- Always-visible label on mobile (no hover state needed) -->
            <div class="absolute bottom-0 inset-x-0 bg-card/95 backdrop-blur-sm border-t-2 border-border p-2 md:p-3">
              <div class="text-[7px] md:text-[8px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <div class="flex items-center justify-between mt-0.5">
                <span class="font-black text-xs md:text-sm">{formatCurrency(p.price)}</span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- ==================== BRAND MARQUEE ==================== -->
  <section class="border-b-2 border-border bg-foreground overflow-hidden">
    <div class="py-3.5 lg:py-4 flex items-center gap-8 whitespace-nowrap" style="animation: brand-scroll-4 25s linear infinite;">
      {[...Array(4)].map(() => brands.map((brand: {name: string}) => (
        <span class="text-lg lg:text-xl font-black uppercase tracking-wider text-background/30 flex items-center gap-8">
          {brand.name}
          <span class="w-1.5 h-1.5 bg-primary rotate-45 block"></span>
        </span>
      )))}
    </div>
  </section>

  <!-- ==================== CATEGORIES — Swipeable pills ==================== -->
  <section class="border-b-2 border-border">
    <div class="px-5 py-3.5 lg:px-8">
      <div class="flex gap-2 overflow-x-auto scrollbar-hide -mx-5 px-5">
        {categoriesForPills.map((cat) => (
          <a href={`/products?category=${cat.id}`} class="flex-none px-3.5 py-2 border-2 border-border bg-card font-bold text-[11px] uppercase tracking-wider active:bg-foreground active:text-background transition-colors">
            {cat.name}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- ==================== FEATURED ==================== -->
  <section class="border-b-2 border-border">
    <div class="px-5 pt-8 pb-10 lg:px-8 lg:py-16">
      <!-- Section header -->
      <div class="mb-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tight">Онцлох</h2>
          <a href="/products?filter=featured" class="text-[11px] font-bold uppercase tracking-wider text-muted-foreground active:text-foreground">Бүгд →</a>
        </div>
        <p class="text-[12px] text-muted-foreground font-medium mt-1">Хамгийн их захиалагддаг бүтээгдэхүүнүүд</p>
      </div>

      <!-- Mobile: 2col tight grid -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-2.5 lg:gap-4">
        {featuredProducts.map((p: ProductForHome) => (
          <div class="group border-2 border-border bg-card active:shadow-hard-sm transition-all">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-4 lg:p-5" width="400" height="400" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2.5">
              <div class="text-[8px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[11px] md:text-xs font-bold line-clamp-2 mt-0.5 leading-tight">{p.name}</h3>
              </a>
              <div class="flex items-center justify-between mt-2 pt-2 border-t-2 border-border">
                <span class="font-black text-[13px] md:text-sm">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- ==================== WHY US — Horizontal scroll cards on mobile ==================== -->
  <section class="border-b-2 border-border bg-muted/20">
    <div class="px-5 py-8 lg:px-8 lg:py-14">
      <h2 class="text-xl md:text-2xl font-black uppercase tracking-tight mb-1">Бидний тухай</h2>
      <p class="text-[12px] text-muted-foreground font-medium mb-5">Товчхон танилцуулъя</p>

      <div class="flex gap-2.5 overflow-x-auto scrollbar-hide -mx-5 px-5 pb-2 lg:grid lg:grid-cols-4 lg:mx-0 lg:px-0 lg:pb-0 lg:gap-3">
        {[
          { num: "01", title: "Шууд импорт", desc: "АНУ-аас шууд авчирдаг. Дунд нь хэн ч ороогүй, хаанаас ирснийг нь мэднэ." },
          { num: "02", title: "FDA баталгаатай", desc: "Бүгд FDA бүртгэлтэй үйлдвэрээс. Лабораторийн шинжилгээ давсан." },
          { num: "03", title: "Хурдан хүргэлт", desc: "УБ хотод 24-48 цагт хүргэнэ. 30,000₮-с дээш бол хүргэлт үнэгүй." },
          { num: "04", title: "Буцаалт боломжтой", desc: "Таарахгүй бол 14 хоногт буцаана. Асуудалгүй." },
        ].map((item) => (
          <div class="flex-none w-[240px] lg:w-auto border-2 border-border bg-card p-4 lg:p-5">
            <span class="text-[10px] font-black text-primary tracking-widest">{item.num}</span>
            <h3 class="font-black text-[13px] md:text-sm uppercase tracking-wider mt-1 mb-1.5">{item.title}</h3>
            <p class="text-[11px] md:text-xs font-medium text-muted-foreground leading-relaxed">{item.desc}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- ==================== NEW ARRIVALS — Swipeable row ==================== -->
  <section class="border-b-2 border-border">
    <div class="px-5 pt-8 pb-10 lg:px-8 lg:py-16">
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tight">Шинэ ирсэн</h2>
        <a href="/products?filter=recent" class="text-[11px] font-bold uppercase tracking-wider text-muted-foreground active:text-foreground">Бүгд →</a>
      </div>
      <p class="text-[12px] text-muted-foreground font-medium mb-5">Сүүлд нэмэгдсэн бүтээгдэхүүнүүд</p>

      <!-- Swipeable on mobile, grid on desktop -->
      <div class="flex gap-2.5 overflow-x-auto scrollbar-hide -mx-5 px-5 pb-2 snap-x snap-mandatory lg:grid lg:grid-cols-4 lg:mx-0 lg:px-0 lg:pb-0 lg:gap-4">
        {newProducts.map((p: ProductForHome) => (
          <div class="flex-none w-[165px] lg:w-auto snap-start group border-2 border-border bg-card">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-3.5 lg:p-5" width="400" height="400" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2 lg:p-3">
              <div class="text-[7px] lg:text-[8px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[10px] lg:text-xs font-bold line-clamp-2 mt-0.5 leading-tight">{p.name}</h3>
              </a>
              <div class="flex items-center justify-between mt-2 pt-2 border-t-2 border-border">
                <span class="font-black text-[12px] lg:text-sm">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- ==================== DISCOUNTED ==================== -->
  <section class="border-b-2 border-border">
    <!-- Dark header strip -->
    <div class="border-b-2 border-border bg-foreground text-background">
      <div class="px-5 py-4 lg:px-8 lg:py-6 flex items-center justify-between">
        <div>
          <h2 class="text-xl md:text-2xl font-black uppercase tracking-tight">Хямдралтай</h2>
          <p class="text-[11px] font-medium text-background/50 mt-0.5">Одоогийн тусгай үнэтэй бүтээгдэхүүнүүд</p>
        </div>
        <a href="/products?filter=discount" class="hidden sm:inline-flex px-4 py-2 border-2 border-background/30 text-background font-bold text-[11px] uppercase tracking-wider active:bg-background active:text-foreground transition-colors">
          Бүгд
        </a>
      </div>
    </div>

    <!-- Products -->
    <div class="px-5 py-8 lg:px-8 lg:py-14">
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-2.5 lg:gap-4">
        {discountedProducts.map((p: ProductForHome) => (
          <div class="group border-2 border-border bg-card active:shadow-hard-sm transition-all">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-[4/3] overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.discount && (
                  <div class="absolute top-1.5 left-1.5 z-10 px-1.5 py-0.5 bg-foreground text-background text-[10px] font-black">-{p.discount}%</div>
                )}
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-3.5 lg:p-4" width="400" height="300" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2.5">
              <div class="text-[7px] lg:text-[8px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[10px] lg:text-xs font-bold line-clamp-2 mt-0.5 leading-tight">{p.name}</h3>
              </a>
              <div class="flex items-center justify-between mt-2 pt-2 border-t-2 border-border">
                <span class="font-black text-[13px] lg:text-sm">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Mobile "see all" link -->
      <a href="/products?filter=discount" class="sm:hidden flex items-center justify-center gap-1 mt-5 py-2.5 border-2 border-border font-bold text-[11px] uppercase tracking-wider active:bg-foreground active:text-background transition-colors">
        Бүгдийг үзэх →
      </a>

      <p class="mt-5 text-[9px] font-semibold text-muted-foreground text-center">Хүнсний нэмэлт нь эмийн орлогч биш.</p>
    </div>
  </section>

  <!-- ==================== FINAL CTA ==================== -->
  <section class="px-5 py-10 lg:px-8 lg:py-16">
    <div class="border-3 border-border bg-primary p-6 lg:p-14 shadow-hard-lg relative overflow-hidden">
      <div class="absolute inset-0 bg-grid-pattern opacity-[0.08] pointer-events-none"></div>
      <div class="relative z-10 max-w-lg mx-auto text-center">
        <h2 class="text-2xl md:text-4xl font-black uppercase tracking-tight mb-3">Бүтээгдэхүүн сонгох</h2>
        <p class="text-[12px] md:text-sm font-medium mb-6 text-foreground/70">
          200 гаруй витамин, нэмэлт тэжээл — бүгд баталгаатай, хүргэлттэй.
        </p>
        <a href="/products" class="inline-flex px-8 py-3.5 bg-foreground text-background font-black text-[13px] uppercase tracking-wider border-2 border-foreground active:scale-[0.97] transition-transform">
          Дэлгүүр хэсэх
        </a>
      </div>
    </div>
  </section>
</Layout>

<style>
  @keyframes brand-scroll-4 {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
</style>
