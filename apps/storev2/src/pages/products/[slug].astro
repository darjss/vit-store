---
export const prerender = true;
import Layout from "@/layouts/Layout.astro";
import { api } from "@/lib/trpc";
import Breadcrumb from "@/components/product/breadcrumb.astro";
import ProductImageCarousel from "@/components/product/product-image-carousel";
import ProductInfo from "@/components/product/product-info.astro";
import ProductDetails from "@/components/product/product-details.astro";
import RecommendedProducts from "@/components/product/recommended-products";
export async function getStaticPaths() {
	const products = await api.product.getAllProducts.query();
	return products.map((product) => ({
		params: { slug: product.slug + "-" + product.id },
	}));
}
const { slug } = Astro.params;
const slugParts = slug.split("-");
const productId = Number(slugParts[slugParts.length - 1]);

if (isNaN(productId)) {
	console.error("Invalid product ID");
	return Astro.redirect("/404");
}

const product = await api.product.getProductById.query({ id: productId });
if (!product) {
	console.error("Product not found");
	return Astro.redirect("/404");
}

const breadcrumbItems = [
	{
		label: "Бүтээгдэхүүн",
		href: "/products",
	},
	{
		label: product.category?.name || "Category",
		href: `/products?category=${product.categoryId}`,
	},
	{
		label: product.name,
		href: "",
	},
];

const primaryImage = product.images.find((img) => img.isPrimary)?.url || product.images[0]?.url || "/placeholder-product.png";
---

<Layout>
	<div class="relative min-h-screen product-page-bg">
		<div class="bg-pattern"></div>
		<div class="bg-gradient"></div>

		<div
			class="relative z-10 mx-auto max-w-screen-2xl px-3 py-4 sm:px-6 sm:py-8 lg:px-8"
		>
			<Breadcrumb items={breadcrumbItems} />

			<div
				class="grid grid-cols-1 gap-8 lg:grid-cols-2 lg:gap-12 mb-12"
			>
				<div class="w-full" transition:name={`product-image-${product.id}`} >
					<ProductImageCarousel
						client:load
						images={product.images}
						productName={product.name}
						productId={product.id}
					/>
				</div>

			<div class="w-full">
				<ProductInfo
					product={product}
					primaryImage={primaryImage}
				/>
			</div>
			</div>

		<div class="mb-12">
			<ProductDetails
				product={{
					description: product.description,
					ingredients: product.ingredients,
					dailyIntake: product.dailyIntake,
					weightGrams: product.weightGrams,
					amount: product.amount,
					potency: product.potency,
				}}
			/>
		</div>

		<div class="border-t-4 border-black pt-10 pb-8">
			<RecommendedProducts
				client:load
				currentProductId={product.id}
				categoryId={product.categoryId}
				brandId={product.brandId}
			/>
		</div>
		</div>
	</div>
</Layout>

<style>
	.product-page-bg {
		--pattern-opacity: 0.4;
		--gradient-opacity: 0.5;
		--color-accent-yellow: #FFF991;
		--color-accent-pink: #FFB6C1;
	}

	.bg-pattern {
		position: absolute;
		inset: 0;
		opacity: var(--pattern-opacity);
		background: #ffffff;
		background-image: radial-gradient(circle at 2px 2px, rgba(0, 0, 0, 0.25) 1.5px, transparent 0);
		background-size: 30px 30px;
	}

	.bg-gradient {
		position: absolute;
		inset: 0;
		opacity: var(--gradient-opacity);
		background-image: 
			radial-gradient(ellipse at 30% 20%, var(--color-accent-yellow) 0%, transparent 50%),
			radial-gradient(ellipse at 70% 80%, var(--color-accent-pink) 0%, transparent 50%);
	}
</style>
