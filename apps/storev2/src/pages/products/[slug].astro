---



import Breadcrumb from "@/components/product/breadcrumb.astro";
import ProductDetails from "@/components/product/product-details.astro";
import ProductImageCarousel from "@/components/product/product-image-carousel.tsx";
import ProductInfo from "@/components/product/product-info.astro";
import RecommendedProducts from "@/components/product/recommended-products.tsx";
import Layout from "@/layouts/Layout.astro";

export const prerender = true;

const SITE_URL = "https://amerikvitamin.mn";

import { api } from "@/lib/trpc";

export async function getStaticPaths() {
	try {
		const products = await api.product.getAllProducts.query();
		return products.map((product) => ({
			params: { slug: `${product.slug}-${product.id}` },
		}));
	} catch (error) {
		console.error("Error getting static paths", error);
		return [];
	}
}

const { slug } = Astro.params;
const slugParts = slug?.split("-") ?? [];
const productId = Number(slugParts[slugParts.length - 1]);

if (Number.isNaN(productId)) {
	console.error("Invalid product ID");
	Astro.redirect("/404");
}

const productData = await api.product.getProductById.query({ id: productId });
if (!productData) {
	console.error("Product not found");
	Astro.redirect("/404");
}

// Use non-null assertion since we've handled the null case above
const product = productData!;

// Determine availability based on status
const isInStock = product.status === "active";
// Calculate sale price if there's a discount
const finalPrice = product.discount && product.discount > 0 
	? Math.round(product.price * (1 - product.discount / 100))
	: product.price;

const breadcrumbItems = [
	{
		label: "Бүтээгдэхүүн",
		href: "/products",
	},
	{
		label: product.category?.name || "Category",
		href: `/products?category=${product.categoryId}`,
	},
	{
		label: product.name,
		href: "",
	},
];

const primaryImage = product.images.find((img) => img.isPrimary)?.url || product.images[0]?.url || "/placeholder-product.png";
const absoluteImage = primaryImage.startsWith("http") ? primaryImage : `${SITE_URL}${primaryImage}`;

// SEO metadata
const seoTitle = product.name;
const seoDescription = product.description 
	? product.description.slice(0, 160) 
	: `${product.name} - ${product.brand?.name || "АНУ"} брэндийн витамин, нэмэлт тэжээл. Америк Витамин дэлгүүрээс захиалаарай.`;

// Product JSON-LD Schema
const productSchema = {
	"@context": "https://schema.org",
	"@type": "Product",
	name: product.name,
	description: product.description || seoDescription,
	image: product.images.map(img => img.url.startsWith("http") ? img.url : `${SITE_URL}${img.url}`),
	brand: {
		"@type": "Brand",
		name: product.brand?.name || "Америк Витамин"
	},
	sku: String(product.id),
	offers: {
		"@type": "Offer",
		url: `${SITE_URL}/products/${slug}`,
		priceCurrency: "MNT",
		price: finalPrice,
		priceValidUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
		availability: isInStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
		seller: {
			"@type": "Organization",
			name: "Америк Витамин"
		}
	},
	...(product.category && {
		category: product.category.name
	})
};

// BreadcrumbList JSON-LD Schema
const breadcrumbSchema = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	itemListElement: [
		{
			"@type": "ListItem",
			position: 1,
			name: "Нүүр",
			item: SITE_URL
		},
		{
			"@type": "ListItem",
			position: 2,
			name: "Бүтээгдэхүүн",
			item: `${SITE_URL}/products`
		},
		...(product.category ? [{
			"@type": "ListItem",
			position: 3,
			name: product.category.name,
			item: `${SITE_URL}/products?category=${product.categoryId}`
		}] : []),
		{
			"@type": "ListItem",
			position: product.category ? 4 : 3,
			name: product.name,
			item: `${SITE_URL}/products/${slug}`
		}
	]
};
---

<Layout 
	title={seoTitle}
	description={seoDescription}
	image={absoluteImage}
	imageAlt={product.name}
>
	<script type="application/ld+json" set:html={JSON.stringify(productSchema)} />
	<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

	<div class="product-page-bg relative min-h-screen">
		<div class="bg-pattern"></div>
		<div class="bg-gradient"></div>

		<div
			class="relative z-10 mx-auto max-w-screen-2xl px-3 py-4 sm:px-6 sm:py-8 lg:px-8"
		>
			<Breadcrumb items={breadcrumbItems} />

			<div
				class="mb-12 grid grid-cols-1 gap-8 lg:grid-cols-2 lg:gap-12"
			>
				<div class="w-full" transition:name={`product-image-${product.id}`} >
					<ProductImageCarousel
						client:load
						images={product.images}
						productName={product.name}
						productId={product.id}
					>
						<div slot="fallback" class="aspect-square min-h-[400px] border-4 border-black bg-white shadow-[8px_8px_0_0_#000]">
							<div class="flex h-full w-full animate-pulse items-center justify-center bg-black/5">
								<div class="h-32 w-32 animate-spin rounded-full border-4 border-black/20 border-t-black"></div>
							</div>
						</div>
					</ProductImageCarousel>
				</div>

			<div class="w-full">
				<ProductInfo
					product={product}
					primaryImage={primaryImage}
				/>
			</div>
			</div>

		<div class="mb-12">
			<ProductDetails
				product={{
					description: product.description,
					ingredients: product.ingredients,
					dailyIntake: product.dailyIntake,
					weightGrams: product.weightGrams,
					expirationDate: product.expirationDate,
					amount: product.amount,
					potency: product.potency,
				}}
			/>
		</div>

		<div class="border-t-4 border-black pb-8 pt-10">
			<RecommendedProducts
				client:load
				currentProductId={product.id}
				categoryId={product.categoryId}
				brandId={product.brandId}
				productName={product.name}
			>
				<div slot="fallback" class="min-h-[300px]">
					<h2 class="mb-6 text-2xl font-black sm:text-3xl">Санал болгох бүтээгдэхүүн</h2>
					<div class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4">
						{[1, 2, 3, 4].map(() => (
							<div class="border-3 border-black bg-white shadow-[4px_4px_0_0_#000]">
								<div class="border-b-3 aspect-[4/3] animate-pulse border-black bg-black/5"></div>
								<div class="space-y-2 p-3">
									<div class="h-4 w-3/4 animate-pulse bg-black/10"></div>
									<div class="h-6 w-1/2 animate-pulse bg-black/10"></div>
								</div>
							</div>
						))}
					</div>
				</div>
			</RecommendedProducts>
		</div>
		</div>
	</div>
</Layout>

<style>
	.product-page-bg {
		--pattern-opacity: 0.4;
		--gradient-opacity: 0.5;
		--color-accent-yellow: #FFF991;
		--color-accent-pink: #FFB6C1;
	}

	.bg-pattern {
		position: absolute;
		inset: 0;
		opacity: var(--pattern-opacity);
		background: #ffffff;
		background-image: radial-gradient(circle at 2px 2px, rgba(0, 0, 0, 0.25) 1.5px, transparent 0);
		background-size: 30px 30px;
	}

	.bg-gradient {
		position: absolute;
		inset: 0;
		opacity: var(--gradient-opacity);
		background-image: 
			radial-gradient(ellipse at 30% 20%, var(--color-accent-yellow) 0%, transparent 50%),
			radial-gradient(ellipse at 70% 80%, var(--color-accent-pink) 0%, transparent 50%);
	}
</style>

<script define:vars={{ productData: { product_id: product.id, product_name: product.name, product_price: product.price, product_slug: slug } }}>
	// Track product view on page load (supports view transitions)
	function trackProductView() {
		if (window.posthog && productData) {
			window.posthog.capture("product_viewed", productData);
		}
	}
	
	// Track on initial load and view transitions
	document.addEventListener("astro:page-load", trackProductView);
</script>
