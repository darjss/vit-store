---
import AddToCartButton from "@/components/cart/add-to-cart-button";
import Layout from "@/layouts/Layout.astro";
import { productColors } from "@/lib/constant";
import { api } from "@/lib/trpc";
import type { ProductForHome } from "@/lib/types";
import { formatCurrency } from "@/lib/utils";

export const prerender = true;

const products = await api.product.getProductsForHome.query();
const { featuredProducts, newProducts, discountedProducts } = products;
const brands = await api.brand.getAllBrands.query();
---

<Layout>
  <!-- DESIGN 3: "CATALOG CLEAN" -->
  <!-- Index/directory feel — tabular trust bar at top, product-first, minimal copy -->
  <!-- Feels like browsing a well-organized catalog or index page -->

  <!-- Tabular header bar -->
  <section class="border-b-2 border-border bg-muted/30">
    <div class="max-w-screen-2xl mx-auto">
      <div class="grid grid-cols-4 divide-x-2 divide-border text-center">
        {[
          { val: "100%", label: "Жинхэнэ" },
          { val: "FDA", label: "Баталгаат" },
          { val: "24-48ц", label: "Хүргэлт" },
          { val: "30K+", label: "Үнэгүй хүргэлт" },
        ].map((s) => (
          <div class="py-3 md:py-4 px-2">
            <span class="font-black text-sm md:text-base">{s.val}</span>
            <span class="text-[8px] md:text-[10px] font-bold uppercase tracking-wider text-muted-foreground ml-1.5">{s.label}</span>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Compact Hero — product-first, minimal text -->
  <section class="border-b-2 border-border">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
      <!-- Section label + title inline -->
      <div class="flex items-baseline gap-4 mb-2">
        <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-muted-foreground">Нүүр</span>
        <div class="h-px flex-1 bg-border"></div>
      </div>
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8 md:mb-10">
        <h1 class="text-3xl md:text-5xl lg:text-6xl font-black uppercase leading-[0.9] tracking-tighter">
          Америк витамин,<br />
          <span class="text-primary">шууд танд.</span>
        </h1>
        <p class="text-sm font-medium text-muted-foreground max-w-sm leading-relaxed">
          АНУ-ын шилдэг брэндүүдийн витамин, нэмэлт тэжээл. Баталгаатай, хүргэлттэй.
        </p>
      </div>

      <!-- Featured: 5-column tight grid -->
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 md:gap-3">
        {featuredProducts.slice(0, 5).map((p: ProductForHome) => (
          <a href={`/products/${p.slug}-${p.id}`} class="group block border-2 border-border bg-card hover:shadow-hard transition-all hover:-translate-y-0.5">
            <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
              {p.image && (
                <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300" width="400" height="400" loading="lazy" />
              )}
            </div>
            <div class="p-2 md:p-2.5">
              <div class="text-[7px] md:text-[8px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <h3 class="text-[10px] md:text-xs font-bold line-clamp-1 mt-0.5 group-hover:underline">{p.name}</h3>
              <div class="font-black text-xs md:text-sm mt-1">{formatCurrency(p.price)}</div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Category index row -->
  <section class="border-b-2 border-border">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-2 py-3 overflow-x-auto scrollbar-hide">
        <span class="text-[9px] font-black uppercase tracking-wider text-muted-foreground whitespace-nowrap mr-2">Индекс</span>
        {["Дархлаа", "Гоо сайхан", "Энерги", "Яс үе мөч", "Зүрх судас", "Ходоод гэдэс", "Нойр", "Тархи мэдрэл"].map((cat, i) => (
          <Fragment>
            {i > 0 && <span class="text-muted-foreground/30 text-xs">/</span>}
            <a href={`/products?category=${encodeURIComponent(cat)}`} class="whitespace-nowrap text-xs font-bold hover:text-primary transition-colors">
              {cat}
            </a>
          </Fragment>
        ))}
      </div>
    </div>
  </section>

  <!-- Featured Products — Full catalog grid -->
  <section class="border-b-2 border-border">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">
      <div class="flex items-baseline gap-4 mb-6 md:mb-8">
        <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-muted-foreground">01</span>
        <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tight">Онцлох</h2>
        <div class="h-px flex-1 bg-border"></div>
        <a href="/products?filter=featured" class="text-xs font-bold uppercase tracking-wider text-muted-foreground hover:text-foreground transition-colors">Бүгдийг үзэх</a>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3">
        {featuredProducts.map((p: ProductForHome) => (
          <div class="group border-2 border-border bg-card hover:shadow-hard transition-all hover:-translate-y-0.5">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-5 group-hover:scale-105 transition-transform duration-300" width="400" height="400" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2 md:p-3">
              <div class="flex items-center justify-between">
                <div class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
                <div class="font-black text-sm">{formatCurrency(p.price)}</div>
              </div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[10px] md:text-xs font-bold line-clamp-1 mt-1 group-hover:underline">{p.name}</h3>
              </a>
              <div class="mt-2 pt-2 border-t-2 border-border flex justify-end">
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- New Arrivals — list/table style on desktop -->
  <section class="border-b-2 border-border bg-muted/10">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">
      <div class="flex items-baseline gap-4 mb-6 md:mb-8">
        <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-muted-foreground">02</span>
        <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tight">Шинэ ирсэн</h2>
        <div class="h-px flex-1 bg-border"></div>
        <a href="/products?filter=recent" class="text-xs font-bold uppercase tracking-wider text-muted-foreground hover:text-foreground transition-colors">Бүгдийг үзэх</a>
      </div>

      <!-- Mobile: scroll row / Desktop: table rows -->
      <div class="hidden lg:block">
        <!-- Table header -->
        <div class="grid grid-cols-12 gap-4 py-2 border-b-2 border-border text-[9px] font-bold uppercase tracking-widest text-muted-foreground">
          <div class="col-span-1"></div>
          <div class="col-span-4">Нэр</div>
          <div class="col-span-2">Брэнд</div>
          <div class="col-span-2 text-right">Үнэ</div>
          <div class="col-span-3 text-right">Сагс</div>
        </div>
        {newProducts.map((p: ProductForHome) => (
          <div class="group grid grid-cols-12 gap-4 py-3 border-b-2 border-border items-center hover:bg-muted/30 transition-colors">
            <div class="col-span-1">
              <a href={`/products/${p.slug}-${p.id}`} class="block w-14 h-14 border-2 border-border overflow-hidden" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="w-full h-full object-contain p-1" width="56" height="56" loading="lazy" />
                )}
              </a>
            </div>
            <div class="col-span-4">
              <a href={`/products/${p.slug}-${p.id}`} class="font-bold text-sm group-hover:underline">{p.name}</a>
            </div>
            <div class="col-span-2">
              <span class="text-[9px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</span>
            </div>
            <div class="col-span-2 text-right">
              <span class="font-black text-base">{formatCurrency(p.price)}</span>
            </div>
            <div class="col-span-3 flex justify-end">
              <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
            </div>
          </div>
        ))}
      </div>

      <!-- Mobile: card scroll -->
      <div class="lg:hidden flex overflow-x-auto gap-3 pb-4 -mx-4 px-4 snap-x snap-mandatory scrollbar-hide">
        {newProducts.map((p: ProductForHome) => (
          <div class="flex-none w-[200px] snap-start group border-2 border-border bg-card hover:shadow-hard transition-all">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300" width="400" height="400" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2">
              <div class="text-[8px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <h3 class="text-[10px] font-bold line-clamp-1 mt-0.5">{p.name}</h3>
              <div class="flex items-center justify-between mt-2 pt-2 border-t-2 border-border">
                <span class="font-black text-xs">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Discounted -->
  <section class="border-b-2 border-border">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">
      <div class="flex items-baseline gap-4 mb-6 md:mb-8">
        <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-muted-foreground">03</span>
        <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tight">Хямдралтай</h2>
        <div class="h-px flex-1 bg-border"></div>
        <a href="/products?filter=discount" class="text-xs font-bold uppercase tracking-wider text-muted-foreground hover:text-foreground transition-colors">Бүгдийг үзэх</a>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3">
        {discountedProducts.map((p: ProductForHome) => (
          <div class="group border-2 border-border bg-card hover:shadow-hard transition-all hover:-translate-y-0.5">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-[4/3] overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.discount && (
                  <div class="absolute top-2 left-2 z-10 px-2 py-0.5 bg-foreground text-background text-[10px] font-black">-{p.discount}%</div>
                )}
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300" width="400" height="300" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2 md:p-3">
              <div class="flex items-center justify-between">
                <div class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
                <div class="font-black text-sm">{formatCurrency(p.price)}</div>
              </div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[10px] md:text-xs font-bold line-clamp-1 mt-1 group-hover:underline">{p.name}</h3>
              </a>
              <div class="mt-2 pt-2 border-t-2 border-border flex justify-end">
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
      <p class="mt-5 text-[10px] font-semibold text-muted-foreground text-center">Эмнэлгийн зөвлөгөө биш. Мэргэжлийн эмчид хандана уу.</p>
    </div>
  </section>

  <!-- Brand ticker -->
  <section class="border-b-2 border-border overflow-hidden">
    <div class="py-3 flex items-center gap-10 whitespace-nowrap" style="animation: brand-scroll-3 30s linear infinite;">
      {[...Array(4)].map(() => brands.map((brand: {name: string}) => (
        <span class="text-sm md:text-base font-black uppercase tracking-wider text-muted-foreground/25 flex items-center gap-10">
          {brand.name}
          <span class="text-[6px] text-muted-foreground/20">///</span>
        </span>
      )))}
    </div>
  </section>

  <!-- Minimal CTA -->
  <section class="py-12 md:py-16">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="border-2 border-border p-8 md:p-12 flex flex-col md:flex-row items-center justify-between gap-6">
        <div>
          <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tight">Бүх бүтээгдэхүүн үзэх</h2>
          <p class="text-sm text-muted-foreground font-medium mt-1">200+ баталгаат витамин, нэмэлт тэжээл</p>
        </div>
        <a href="/products" class="inline-flex px-8 py-3.5 bg-foreground text-background font-bold text-sm uppercase tracking-wider border-2 border-foreground hover:bg-primary hover:text-foreground hover:border-border transition-colors">
          Каталог
        </a>
      </div>
    </div>
  </section>
</Layout>

<style>
  @keyframes brand-scroll-3 {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
</style>
