---



import ClearCart from "@/components/payment/clear-cart";
import Layout from "@/layouts/Layout.astro";
import { createServerClient } from "@/lib/trpc";
import IconCheck from "~icons/ri/check-line";
import IconReceipt from "~icons/ri/file-list-3-line";
import IconHome from "~icons/ri/home-4-line";

const { paymentNumber } = Astro.params;

if (!paymentNumber) {
    throw Astro.redirect("/404");
}

const cookieHeader = Astro.request.headers.get("cookie") || "";
const serverApi = createServerClient(cookieHeader, Astro.locals.runtime.env.server, Astro.redirect);
const payment = await serverApi.payment.getPaymentByNumber.query({ paymentNumber });

if (!payment) {
    throw Astro.redirect("/404");
}

if (payment.status !== "success") {
	throw Astro.redirect(`/payment/${paymentNumber}`);
}
---

<Layout>
    <ClearCart client:load />
    <div class="container mx-auto px-4 py-8 min-h-screen">
        <!-- Success Header -->
        <div class="mb-12 text-center">
            <div class="mb-6 inline-flex h-24 w-24 items-center justify-center rounded-full border-4 border-black bg-success text-success-foreground shadow-[8px_8px_0_0_#000]">
                <IconCheck class="h-12 w-12" />
            </div>
            <h1 class="mb-4 font-black text-3xl uppercase tracking-tight md:text-5xl">
                Төлбөр амжилттай!
            </h1>
            <p class="text-lg text-muted-foreground max-w-md mx-auto">
                Таны QPay төлбөр амжилттай хийгдлээ. Захиалга баталгаажлаа.
            </p>
        </div>

        <!-- Payment Summary -->
        <div class="max-w-2xl mx-auto mb-8">
            <div class="border-4 border-black bg-card shadow-[8px_8px_0_0_#000]">
                <div class="p-6 border-b-4 border-black bg-primary/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-muted-foreground font-bold uppercase">Төлбөрийн дугаар</p>
                            <p class="font-mono font-black text-lg">{paymentNumber}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-muted-foreground font-bold uppercase">Захиалгын дугаар</p>
                            <p class="font-mono font-black text-lg">{payment.order.orderNumber}</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 space-y-4">
                    <!-- Products -->
                    <div>
                        <h3 class="font-black uppercase tracking-tight mb-3 text-sm text-muted-foreground">Бүтээгдэхүүнүүд</h3>
                        <div class="space-y-2">
                            {payment.order.products.map((product) => (
                                <div class="flex items-center gap-3 p-3 border-2 border-border bg-background">
                                    {product.imageUrl && (
                                        <img
                                            src={product.imageUrl}
                                            alt={product.name}
                                            class="w-12 h-12 object-cover border-2 border-border shrink-0"
                                        />
                                    )}
                                    <div class="flex-1 min-w-0">
                                        <p class="font-bold text-sm truncate">{product.name}</p>
                                        <p class="text-xs text-muted-foreground">{product.quantity}x</p>
                                    </div>
                                    <p class="font-black text-sm shrink-0">
                                        {(product.price * product.quantity).toLocaleString()}₮
                                    </p>
                                </div>
                            ))}
                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <div class="pt-4 border-t-2 border-border">
                        <h3 class="font-black uppercase tracking-tight mb-2 text-sm text-muted-foreground">Хүргэлтийн хаяг</h3>
                        <p class="font-medium">{payment.order.address}</p>
                    </div>

                    <!-- Total -->
                    <div class="pt-4 border-t-2 border-border">
                        <div class="flex items-center justify-between">
                            <span class="font-black uppercase">Нийт төлсөн</span>
                            <span class="font-black text-2xl text-primary">{payment.total.toLocaleString()}₮</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="max-w-2xl mx-auto">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a 
                    href={`/order/confirm/${payment.order.orderNumber}`}
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-black uppercase tracking-wide transition-all focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-ring focus-visible:ring-offset-2 border-3 border-black bg-primary text-primary-foreground shadow-[6px_6px_0_0_#000] hover:shadow-[3px_3px_0_0_#000] hover:translate-x-[3px] hover:translate-y-[3px] active:shadow-none h-12 md:h-14 px-6 md:px-8 py-3 text-sm md:text-base"
                >
                    <IconReceipt class="w-5 h-5" />
                    Захиалга харах
                </a>
                <a 
                    href="/"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-black uppercase tracking-wide transition-all focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-ring focus-visible:ring-offset-2 border-3 border-black bg-white text-black shadow-[6px_6px_0_0_#000] hover:shadow-[3px_3px_0_0_#000] hover:translate-x-[3px] hover:translate-y-[3px] active:shadow-none h-12 md:h-14 px-6 md:px-8 py-3 text-sm md:text-base"
                >
                    <IconHome class="w-5 h-5" />
                    Нүүр хуудас
                </a>
            </div>
        </div>

        <!-- Info Box -->
        <div class="max-w-2xl mx-auto mt-8">
            <div class="border-3 border-border bg-muted/30 p-4">
                <p class="text-sm text-muted-foreground text-center">
                    Таны захиалгын мэдээллийг имэйл эсвэл мессежээр илгээх болно. 
                    Хүргэлт 1-3 хоногийн дотор хийгдэнэ.
                </p>
            </div>
        </div>
    </div>
</Layout>
