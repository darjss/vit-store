---



import PaymentOptions from "@/components/payment/payment-options";
import Layout from "@/layouts/Layout.astro";
import { createServerClient } from "@/lib/trpc";
import IconCreditCard from "~icons/ri/bank-card-line";

const { id } = Astro.params;
if(id===undefined){
     throw Astro.redirect("/404");
}
const cookieHeader = Astro.request.headers.get("cookie") || "";
const serverApi = createServerClient(cookieHeader, Astro.locals.runtime.env.server, Astro.redirect);
const payment = await serverApi.payment.getPaymentByNumber.query({ paymentNumber: id });
if(!payment){
    throw Astro.redirect("/404");
}

if (payment.status === "success") {
    throw Astro.redirect(`/payment/success/${payment.paymentNumber}`);
}
---

<Layout>
    <div class="container mx-auto px-3 py-4 sm:px-4 sm:py-6 max-w-3xl min-h-screen">
        <div class="mb-4 sm:mb-6">
            <div class="border-3 sm:border-4 border-border bg-primary p-3 sm:p-4 shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[6px_6px_0_0_rgba(0,0,0,1)] mb-3 sm:mb-4">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 border-3 border-border bg-card flex items-center justify-center">
                        <IconCreditCard class="h-6 w-6" />
                    </div>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-black uppercase tracking-tight">
                            Төлбөр төлөх
                        </h1>
                        <p class="text-xs sm:text-sm font-bold text-muted-foreground mt-0.5">
                            #{payment.order.orderNumber}
                        </p>
                    </div>
                </div>
            </div>

            <div class="border-3 sm:border-4 border-border bg-card shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[6px_6px_0_0_rgba(0,0,0,1)] mb-4 sm:mb-6">
                <div class="p-3 sm:p-4 space-y-3">
                    <div class="flex items-center justify-between p-2.5 sm:p-3 border-2 border-border bg-muted/30">
                        <span class="text-xs sm:text-sm font-bold text-muted-foreground">НИЙТ ДҮН</span>
                        <span class="text-lg sm:text-xl font-black text-primary">{payment.total.toLocaleString()}₮</span>
                    </div>
                    <div class="space-y-2">
                        {payment.order.products.map((product) => (
                            <div class="flex items-center gap-2 sm:gap-3 p-2 sm:p-2.5 border-2 border-border bg-background">
                                {product.imageUrl && (
                                    <img
                                        src={product.imageUrl}
                                        alt={product.name}
                                        class="w-10 h-10 sm:w-12 sm:h-12 object-cover border-2 border-border shrink-0"
                                    />
                                )}
                                <span class="text-xs sm:text-sm font-bold flex-1 line-clamp-2">{product.name}</span>
                                <span class="text-xs font-bold text-muted-foreground px-1.5 py-0.5 sm:px-2 sm:py-1 border-2 border-border bg-muted shrink-0">{product.quantity}x</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>

        <PaymentOptions
            paymentNumber={id}
            total={payment.total}
            orderNumber={payment.order.orderNumber}
            client:load
        >
            <div slot="fallback" class="w-full border-3 border-border bg-card p-4 shadow-[4px_4px_0_0_rgba(0,0,0,1)]">
                <div class="h-10 w-full animate-pulse border-2 border-border bg-muted/40"></div>
            </div>
        </PaymentOptions>
    </div>
</Layout>
