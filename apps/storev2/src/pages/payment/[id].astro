---

import ConfirmPaymentButton from "@/components/payment/confirm-payment-button";
import Tabs from "@/components/starwind/tabs/Tabs.astro";
import TabsContent from "@/components/starwind/tabs/TabsContent.astro";
import TabsList from "@/components/starwind/tabs/TabsList.astro";
import TabsTrigger from "@/components/starwind/tabs/TabsTrigger.astro";
import CopyButton from "@/components/ui/copy-button";
import Layout from "@/layouts/Layout.astro";
import { createServerClient } from "@/lib/trpc";

const { id } = Astro.params;
if(id===undefined){
    return Astro.redirect("/404");
}
const cookieHeader = Astro.request.headers.get("cookie") || "";
const serverApi = createServerClient(cookieHeader, Astro.locals.runtime.env.server, Astro.redirect);
const payment = await serverApi.payment.getPaymentByNumber.query({ paymentNumber: id });
if(!payment){
    return Astro.redirect("/404");
}
---

<Layout>
    <div class="container mx-auto px-3 py-4 sm:px-4 sm:py-6 max-w-3xl min-h-screen">
        <!-- Header Section -->
        <div class="mb-4 sm:mb-6">
            <div class="border-3 sm:border-4 border-border bg-primary p-3 sm:p-4 shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[6px_6px_0_0_rgba(0,0,0,1)] mb-3 sm:mb-4">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 border-3 border-border bg-card flex items-center justify-center text-xl sm:text-2xl">
                        üí≥
                    </div>
                    <div class="flex-1 min-w-0">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-black uppercase tracking-tight">
                            –¢”©–ª–±”©—Ä —Ç”©–ª”©—Ö
                        </h1>
                        <p class="text-xs sm:text-sm font-bold text-muted-foreground mt-0.5">
                            #{payment.order.orderNumber}
                        </p>
                    </div>
                </div>
            </div>

            <div class="border-3 sm:border-4 border-border bg-card shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[6px_6px_0_0_rgba(0,0,0,1)] mb-4 sm:mb-6">
                <div class="p-3 sm:p-4 space-y-3">
                    <div class="flex items-center justify-between p-2.5 sm:p-3 border-2 border-border bg-muted/30">
                        <span class="text-xs sm:text-sm font-bold text-muted-foreground">–ù–ò–ô–¢ –î“Æ–ù</span>
                        <span class="text-lg sm:text-xl font-black text-primary">{payment.total.toLocaleString()}‚ÇÆ</span>
                    </div>
                    <div class="space-y-2">
                        {payment.order.products.map((product) => (
                            <div class="flex items-center gap-2 sm:gap-3 p-2 sm:p-2.5 border-2 border-border bg-background">
                                {product.imageUrl && (
                                    <img 
                                        src={product.imageUrl} 
                                        alt={product.name}
                                        class="w-10 h-10 sm:w-12 sm:h-12 object-cover border-2 border-border shrink-0"
                                    />
                                )}
                                <span class="text-xs sm:text-sm font-bold flex-1 line-clamp-2">{product.name}</span>
                                <span class="text-xs font-bold text-muted-foreground px-1.5 py-0.5 sm:px-2 sm:py-1 border-2 border-border bg-muted shrink-0">{product.quantity}x</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>

        <Tabs defaultValue="transfer" class="w-full">
            <TabsList class="w-full grid grid-cols-2 gap-1.5 sm:gap-2 p-1.5 sm:p-2 bg-muted/50 border-3 sm:border-4 border-border rounded-sm shadow-[3px_3px_0_0_#000] sm:shadow-[4px_4px_0_0_#000] mb-4 sm:mb-6">
                <TabsTrigger 
                    value="transfer" 
                    class="text-xs sm:text-sm font-black px-3 py-2.5 sm:px-4 sm:py-3 rounded-sm transition-all data-[state=active]:bg-primary data-[state=active]:border-2 data-[state=active]:border-black data-[state=active]:shadow-[2px_2px_0_0_#000] hover:bg-primary/30"
                >
                    <span class="flex items-center justify-center gap-1.5 sm:gap-2">
                        <span class="text-sm sm:text-base">üè¶</span>
                        <span>–î–∞–Ω—Å</span>
                    </span>
                </TabsTrigger>
                <TabsTrigger 
                    value="qpay" 
                    class="text-xs sm:text-sm font-black px-3 py-2.5 sm:px-4 sm:py-3 rounded-sm transition-all data-[state=active]:bg-primary data-[state=active]:border-2 data-[state=active]:border-black data-[state=active]:shadow-[2px_2px_0_0_#000] hover:bg-primary/30"
                >
                    <span class="flex items-center justify-center gap-1.5 sm:gap-2">
                        <span class="text-sm sm:text-base">üì±</span>
                        <span>QPay</span>
                    </span>
                </TabsTrigger>
            </TabsList>

            <TabsContent value="transfer">
                <div class="border-3 sm:border-4 border-border bg-card shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[6px_6px_0_0_rgba(0,0,0,1)]">
                    <div class="p-3 sm:p-4 space-y-4 sm:space-y-5">
                        <div class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 border-2 border-border bg-muted/30">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 border-2 border-border bg-white rounded-full flex items-center justify-center shrink-0">
                                <img src="/khaan.png" alt="Khaan logo" class="w-full h-full object-contain p-1.5 sm:p-2" />
                            </div>
                            <div>
                                <div class="text-[10px] sm:text-xs font-bold text-muted-foreground mb-0.5">–ë–ê–ù–ö</div>
                                <div class="text-sm sm:text-base font-black">–•–∞–∞–Ω –±–∞–Ω–∫</div>
                            </div>
                        </div>

                        <!-- Payment Details Grid -->
                        <div class="space-y-3">
                            <div class="grid sm:grid-cols-2 gap-2.5 sm:gap-3">
                                <!-- Account Number -->
                                <div class="space-y-1.5">
                                    <label class="text-[10px] sm:text-xs font-bold text-muted-foreground uppercase">
                                        –î–∞–Ω—Å
                                    </label>
                                    <div class="flex items-stretch">
                                        <div class="flex-1 px-2.5 py-2 sm:px-3 sm:py-2.5 bg-white border-2 border-border rounded-l-sm text-sm sm:text-base font-black">
                                            5063627657
                                        </div>
                                        <CopyButton text="5063627657" title="–î–∞–Ω—Å" client:load />
                                    </div>
                                </div>

                                <!-- Account Name -->
                                <div class="space-y-1.5">
                                    <label class="text-[10px] sm:text-xs font-bold text-muted-foreground uppercase">
                                        –ù—ç—Ä
                                    </label>
                                    <div class="flex items-stretch">
                                        <div class="flex-1 px-2.5 py-2 sm:px-3 sm:py-2.5 bg-white border-2 border-border rounded-l-sm text-xs sm:text-sm font-bold leading-tight">
                                            –û–ª—É—É–ª–∞–∞ –ò–∫–æ–º–º–µ—Ä—Å –•–•–ö
                                        </div>
                                        <CopyButton text="–û–ª—É—É–ª–∞–∞ –ò–∫–æ–º–º–µ—Ä—Å –•–•–ö" title="–ù—ç—Ä" client:load />
                                    </div>
                                </div>

                                <!-- Amount -->
                                <div class="space-y-1.5">
                                    <label class="text-[10px] sm:text-xs font-bold text-muted-foreground uppercase">
                                        –î“Ø–Ω
                                    </label>
                                    <div class="flex items-stretch">
                                        <div class="flex-1 px-2.5 py-2 sm:px-3 sm:py-2.5 bg-primary/20 border-2 border-border rounded-l-sm text-base sm:text-lg font-black text-primary">
                                            {payment.total.toLocaleString()}‚ÇÆ
                                        </div>
                                        <CopyButton text={payment.total} title="–î“Ø–Ω" client:load />
                                    </div>
                                </div>

                                <div class="space-y-1.5">
                                    <label class="text-[10px] sm:text-xs font-bold text-muted-foreground uppercase">
                                        –ì“Ø–π–ª–≥—ç—ç–Ω–∏–π —É—Ç–≥–∞
                                    </label>
                                    <div class="flex items-stretch">
                                        <div class="flex-1 px-2.5 py-2 sm:px-3 sm:py-2.5 bg-white border-2 border-border rounded-l-sm text-sm sm:text-base font-black">
                                            {payment.order.orderNumber}
                                        </div>
                                        <CopyButton text={payment.order.orderNumber} title="–ì“Ø–π–ª–≥—ç—ç–Ω–∏–π —É—Ç–≥–∞" client:load />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="p-2.5 sm:p-3 border-2 border-border bg-yellow-50">
                            <div class="flex items-start gap-2 sm:gap-2.5">
                                <span class="text-base sm:text-lg shrink-0">‚ö†Ô∏è</span>
                                <div class="flex-1">
                                    <p class="text-[11px] sm:text-xs font-bold leading-snug">
                                        <strong>–ì“Ø–π–ª–≥—ç—ç–Ω–∏–π —É—Ç–≥–∞</strong> —Ö—ç—Å—ç–≥—Ç –∑–∞–∞–≤–∞–ª <strong>{payment.order.orderNumber}</strong> –¥—É–≥–∞–∞—Ä—ã–≥ –±–∏—á–Ω—ç “Ø“Ø. –¢”©–ª–±”©—Ä 5-15 –º–∏–Ω—É—Ç—ã–Ω –¥–æ—Ç–æ—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂–Ω–∞.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <ConfirmPaymentButton paymentNumber={id as string} client:load/>
                    </div>
                </div>
            </TabsContent>

            <!-- QPay Tab -->
            <TabsContent value="qpay">
                <div class="border-3 sm:border-4 border-border bg-card shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[6px_6px_0_0_rgba(0,0,0,1)]">
                    <div class="p-4 sm:p-5">
                        <div class="flex flex-col md:flex-row items-center md:items-start gap-4 sm:gap-5 md:gap-6">
                            <!-- QPay Logo -->
                            <div class="w-24 h-24 sm:w-32 sm:h-32 md:w-40 md:h-40 border-3 border-border bg-[#21399C] rounded-sm flex items-center justify-center p-3 sm:p-4 md:p-5 shadow-[3px_3px_0_0_rgba(0,0,0,1)] sm:shadow-[4px_4px_0_0_rgba(0,0,0,1)] shrink-0">
                                <img src="/qpay.png" alt="QPay logo" class="w-full h-full object-contain" />
                            </div>

                            <div class="flex-1 flex flex-col items-center md:items-start gap-3 sm:gap-4">
                                <div class="text-center md:text-left">
                                    <h3 class="text-lg sm:text-xl md:text-2xl font-black mb-2">
                                        –•—É—Ä–¥–∞–Ω —Ç”©–ª–±”©—Ä
                                    </h3>
                                    <p class="text-xs sm:text-sm font-bold text-muted-foreground leading-relaxed max-w-md">
                                        QPay-—ç—ç—Ä —Ç”©–ª–±”©—Ä —Ç”©–ª—Å–Ω”©”©—Ä —Ç–∞–Ω—ã –∑–∞—Ö–∏–∞–ª–≥–∞ —à—É—É–¥ –±–∞—Ç–∞–ª–≥–∞–∞–∂–Ω–∞.
                                    </p>
                                </div>

                                <a
                                    href="/qpay"
                                    class="w-full md:w-auto md:min-w-[240px] px-4 py-3 sm:py-3.5 bg-primary border-3 sm:border-4 border-border font-black text-sm sm:text-base uppercase shadow-[4px_4px_0_0_rgba(0,0,0,1)] sm:shadow-[5px_5px_0_0_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-[2px_2px_0_0_rgba(0,0,0,1)] transition-all flex items-center justify-center gap-2 text-center"
                                >
                                    <span>QPay-—ç—ç—Ä —Ç”©–ª”©—Ö</span>
                                    <span>‚Üí</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </TabsContent>
        </Tabs>
    </div>
</Layout>
