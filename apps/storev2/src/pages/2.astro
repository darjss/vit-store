---
import AddToCartButton from "@/components/cart/add-to-cart-button";
import Layout from "@/layouts/Layout.astro";
import { productColors } from "@/lib/constant";
import { api } from "@/lib/trpc";
import type { ProductForHome } from "@/lib/types";
import { formatCurrency } from "@/lib/utils";

export const prerender = true;

const products = await api.product.getProductsForHome.query();
const { featuredProducts, newProducts, discountedProducts } = products;
const brands = await api.brand.getAllBrands.query();
---

<Layout>
  <!-- DESIGN 2: "SOFT LUXURY" -->
  <!-- Dark hero section transitioning to clean white, asymmetric product grids -->
  <!-- Quiet confidence: dark meets light, editorial spacing, generous whitespace -->

  <!-- Dark Hero -->
  <section class="relative overflow-hidden bg-foreground text-background border-b-2 border-border">
    <div class="absolute inset-0 bg-dots-pattern opacity-[0.06] pointer-events-none"></div>

    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-28">
      <div class="grid md:grid-cols-2 gap-10 md:gap-16 items-center">
        <!-- Left: Text -->
        <div>
          <div class="inline-flex items-center gap-2 mb-6">
            <div class="w-8 h-0.5 bg-primary"></div>
            <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-background/50">Итгэлтэй сонголт</span>
          </div>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-black uppercase leading-[0.9] tracking-tighter mb-5">
            Чанартай витамин,<br />
            <span class="text-primary">шууд АНУ-аас.</span>
          </h1>
          <p class="text-sm md:text-base font-medium text-background/60 max-w-md leading-relaxed mb-8">
            FDA стандарт, лабораторийн шинжилгээ баталгаатай. 200+ бүтээгдэхүүн, 24-48ц хүргэлт.
          </p>
          <div class="flex flex-wrap gap-3">
            <a href="/products" class="inline-flex px-8 py-3.5 bg-primary text-foreground font-bold text-sm uppercase tracking-wider border-2 border-primary hover:bg-primary/80 transition-colors">
              Бүтээгдэхүүн үзэх
            </a>
            <a href="/products?filter=discount" class="inline-flex px-8 py-3.5 bg-transparent text-background font-bold text-sm uppercase tracking-wider border-2 border-background/30 hover:border-background transition-colors">
              Хямдралтай
            </a>
          </div>
        </div>

        <!-- Right: Asymmetric featured duo -->
        <div class="relative">
          <div class="grid grid-cols-2 gap-3">
            {featuredProducts.slice(0, 2).map((p: ProductForHome, i: number) => (
              <a href={`/products/${p.slug}-${p.id}`} class={`group block border-2 border-background/20 overflow-hidden hover:border-primary transition-colors ${i === 0 ? 'mt-0' : 'mt-8'}`}>
                <div class="relative aspect-[3/4] overflow-hidden" style={`background: ${productColors[p.id % productColors.length]}`}>
                  {p.image && (
                    <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-5 md:p-8 group-hover:scale-105 transition-transform duration-500" width="400" height="500" loading="lazy" />
                  )}
                </div>
                <div class="p-2.5 md:p-3 bg-foreground border-t-2 border-background/20">
                  <div class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-background/40">{p.brand}</div>
                  <h3 class="text-[11px] md:text-sm font-bold leading-tight line-clamp-1 mt-0.5 text-background">{p.name}</h3>
                  <div class="font-black text-sm md:text-base mt-1 text-primary">{formatCurrency(p.price)}</div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Trust bar — light transition -->
  <section class="border-b-2 border-border bg-background">
    <div class="max-w-screen-2xl mx-auto grid grid-cols-2 md:grid-cols-4 divide-x-2 divide-border">
      {[
        { val: "100%", label: "Жинхэнэ бүтээгдэхүүн" },
        { val: "FDA", label: "Стандарт баталгаа" },
        { val: "24-48ц", label: "Хүргэлт УБ хотод" },
        { val: "200+", label: "Бүтээгдэхүүн" },
      ].map((s, i) => (
        <div class={`py-5 md:py-6 px-4 text-center ${i < 2 ? 'border-b-2 md:border-b-0 border-border' : ''}`}>
          <div class="text-xl md:text-2xl font-black">{s.val}</div>
          <div class="text-[9px] md:text-[10px] font-bold uppercase tracking-wider text-muted-foreground mt-0.5">{s.label}</div>
        </div>
      ))}
    </div>
  </section>

  <!-- Featured Products — Asymmetric Grid: 1 large + 3 small -->
  <section class="border-b-2 border-border">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20">
      <div class="flex items-end justify-between mb-8 md:mb-12">
        <div>
          <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-muted-foreground">Бестселлер</span>
          <h2 class="text-3xl md:text-4xl font-black uppercase tracking-tight mt-1">Онцлох бүтээгдэхүүн</h2>
        </div>
        <a href="/products?filter=featured" class="hidden sm:inline-flex px-4 py-2 border-2 border-border font-bold text-xs uppercase tracking-wider hover:bg-foreground hover:text-background transition-colors">
          Бүгдийг үзэх
        </a>
      </div>

      <!-- Asymmetric: first product large, rest in grid -->
      <div class="grid lg:grid-cols-5 gap-4 md:gap-5">
        <!-- Large featured card -->
        {featuredProducts.slice(0, 1).map((p: ProductForHome) => (
          <div class="lg:col-span-2 lg:row-span-2 group border-2 border-border bg-card hover:shadow-hard-lg transition-all hover:-translate-y-1">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-[3/4] lg:aspect-auto lg:h-full lg:min-h-[500px] overflow-hidden border-b-2 lg:border-b-0 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-8 md:p-14 group-hover:scale-105 transition-transform duration-500" width="500" height="600" loading="lazy" />
                )}
                <div class="absolute bottom-0 inset-x-0 p-4 md:p-6 bg-gradient-to-t from-black/50 to-transparent">
                  <div class="text-[9px] font-bold uppercase tracking-widest text-white/60">{p.brand}</div>
                  <h3 class="text-lg md:text-xl font-black text-white leading-tight mt-1">{p.name}</h3>
                  <div class="flex items-center justify-between mt-3">
                    <span class="font-black text-xl text-white">{formatCurrency(p.price)}</span>
                    <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
                  </div>
                </div>
              </div>
            </a>
          </div>
        ))}

        <!-- Remaining featured products in compact grid -->
        <div class="lg:col-span-3 grid grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
          {featuredProducts.slice(1).map((p: ProductForHome) => (
            <div class="group border-2 border-border bg-card hover:shadow-hard transition-all hover:-translate-y-0.5">
              <a href={`/products/${p.slug}-${p.id}`} class="block">
                <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                  {p.image && (
                    <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300" width="400" height="400" loading="lazy" />
                  )}
                </div>
              </a>
              <div class="p-2 md:p-3">
                <div class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
                <a href={`/products/${p.slug}-${p.id}`}>
                  <h3 class="text-[10px] md:text-xs font-bold line-clamp-2 mt-0.5 leading-tight group-hover:underline">{p.name}</h3>
                </a>
                <div class="flex items-center justify-between mt-2 pt-2 border-t-2 border-border">
                  <span class="font-black text-sm">{formatCurrency(p.price)}</span>
                  <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Categories — Horizontal pill row -->
  <section class="border-b-2 border-border bg-muted/20">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-12">
      <div class="flex items-center gap-4 md:gap-6 overflow-x-auto scrollbar-hide pb-2">
        <span class="text-xs font-black uppercase tracking-wider text-muted-foreground whitespace-nowrap">Ангилал:</span>
        {["Дархлаа", "Гоо сайхан", "Энерги", "Яс үе мөч", "Зүрх судас", "Ходоод гэдэс", "Нойр", "Тархи мэдрэл"].map((cat) => (
          <a href={`/products?category=${encodeURIComponent(cat)}`} class="whitespace-nowrap px-4 py-2 border-2 border-border bg-card font-bold text-xs uppercase tracking-wider hover:bg-foreground hover:text-background transition-colors">
            {cat}
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- New Arrivals — Horizontal scroll -->
  <section class="border-b-2 border-border">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20">
      <div class="flex items-end justify-between mb-8 md:mb-10">
        <div>
          <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-muted-foreground">Шинэ нэмэгдсэн</span>
          <h2 class="text-3xl md:text-4xl font-black uppercase tracking-tight mt-1">Шинэ ирсэн</h2>
        </div>
        <a href="/products?filter=recent" class="hidden sm:inline-flex px-4 py-2 border-2 border-border font-bold text-xs uppercase tracking-wider hover:bg-foreground hover:text-background transition-colors">
          Бүгдийг үзэх
        </a>
      </div>

      <div class="flex overflow-x-auto gap-3 md:gap-4 pb-4 -mx-4 px-4 snap-x snap-mandatory scrollbar-hide lg:grid lg:grid-cols-4 lg:overflow-visible lg:mx-0 lg:px-0 lg:pb-0">
        {newProducts.map((p: ProductForHome) => (
          <div class="flex-none w-[230px] lg:w-auto snap-start group border-2 border-border bg-card hover:shadow-hard transition-all hover:-translate-y-0.5">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-square overflow-hidden border-b-2 border-border" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-5 group-hover:scale-105 transition-transform duration-300" width="400" height="400" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2.5 md:p-3.5">
              <div class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-muted-foreground">{p.brand}</div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[11px] md:text-sm font-bold line-clamp-2 mt-0.5 leading-tight group-hover:underline">{p.name}</h3>
              </a>
              <div class="flex items-center justify-between mt-2.5 pt-2.5 border-t-2 border-border">
                <span class="font-black text-sm md:text-base">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Discounted Products -->
  <section class="border-b-2 border-border bg-foreground text-background">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20">
      <div class="flex items-end justify-between mb-8 md:mb-10">
        <div>
          <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-background/40">Тусгай санал</span>
          <h2 class="text-3xl md:text-4xl font-black uppercase tracking-tight mt-1 text-background">Хямдралтай</h2>
        </div>
        <a href="/products?filter=discount" class="hidden sm:inline-flex px-4 py-2 border-2 border-background/30 text-background font-bold text-xs uppercase tracking-wider hover:bg-background hover:text-foreground transition-colors">
          Бүгдийг үзэх
        </a>
      </div>

      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-5">
        {discountedProducts.map((p: ProductForHome) => (
          <div class="group border-2 border-background/20 bg-foreground hover:border-primary transition-all hover:-translate-y-0.5">
            <a href={`/products/${p.slug}-${p.id}`} class="block">
              <div class="relative aspect-[4/3] overflow-hidden border-b-2 border-background/20" style={`background: ${productColors[p.id % productColors.length]}`}>
                {p.discount && (
                  <div class="absolute top-2 left-2 z-10 px-2 py-0.5 bg-primary text-foreground text-[10px] font-black border-2 border-foreground">-{p.discount}%</div>
                )}
                {p.image && (
                  <img src={p.image} alt={p.name} class="absolute inset-0 w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300" width="400" height="300" loading="lazy" />
                )}
              </div>
            </a>
            <div class="p-2.5 md:p-3.5">
              <div class="text-[8px] md:text-[9px] font-bold uppercase tracking-widest text-background/40">{p.brand}</div>
              <a href={`/products/${p.slug}-${p.id}`}>
                <h3 class="text-[11px] md:text-sm font-bold line-clamp-2 mt-0.5 leading-tight text-background group-hover:underline">{p.name}</h3>
              </a>
              <div class="flex items-center justify-between mt-2.5 pt-2.5 border-t-2 border-background/20">
                <span class="font-black text-sm md:text-base text-primary">{formatCurrency(p.price)}</span>
                <AddToCartButton client:load compact cartItem={{ productId: p.id, quantity: 1, name: p.name, price: p.price, image: p.image }} />
              </div>
            </div>
          </div>
        ))}
      </div>
      <p class="mt-5 text-[10px] font-semibold text-background/30 text-center">Эмнэлгийн зөвлөгөө биш. Мэргэжлийн эмчид хандана уу.</p>
    </div>
  </section>

  <!-- Brand ticker -->
  <section class="border-b-2 border-border overflow-hidden bg-background">
    <div class="py-4 flex items-center gap-12 whitespace-nowrap" style="animation: brand-scroll-2 35s linear infinite;">
      {[...Array(4)].map(() => brands.map((brand: {name: string}) => (
        <span class="text-lg md:text-xl font-black uppercase tracking-wider text-muted-foreground/30 flex items-center gap-12">
          {brand.name}
          <span class="w-1.5 h-1.5 bg-primary/40 rotate-45 block"></span>
        </span>
      )))}
    </div>
  </section>

  <!-- CTA -->
  <section class="py-14 md:py-20">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="border-4 border-border bg-foreground text-background p-8 md:p-14 shadow-hard-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-dots-pattern opacity-[0.05] pointer-events-none"></div>
        <div class="relative z-10 max-w-xl mx-auto text-center">
          <h2 class="text-3xl md:text-5xl font-black uppercase tracking-tight mb-4 text-background">Эрүүл мэндээ бодоорой</h2>
          <p class="text-sm md:text-base font-medium mb-8 text-background/60">АНУ-ын шилдэг витамин, нэмэлт тэжээл — баталгаатай, хүргэлттэй.</p>
          <a href="/products" class="inline-flex px-10 py-4 bg-primary text-foreground font-black text-sm uppercase tracking-wider border-2 border-primary hover:bg-primary/80 transition-colors">
            Дэлгүүр хэсэх
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  @keyframes brand-scroll-2 {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
</style>
