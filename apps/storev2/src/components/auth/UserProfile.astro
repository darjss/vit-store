---
import { Dropdown, DropdownContent, DropdownItem, DropdownLabel, DropdownTrigger } from "@/components/starwind/dropdown";
import LogoutButton from "@/components/auth/logout-button";
import { createServerClient } from "@/lib/trpc";

const cookieHeader = Astro.request.headers.get("cookie") || "";
const serverApi = createServerClient(cookieHeader, Astro.locals.runtime.env.server);

let user = null;
try {
	user = await serverApi.auth.check.query();
} catch (error) {
	console.log(error)
}
---

<Dropdown class="user-profile-dropdown">
	<DropdownTrigger
		aria-label="Профайл"
		class="relative flex items-center justify-center w-9 h-9 border-2 border-border bg-background shadow-hard-sm transition-all hover:translate-x-[1px] hover:translate-y-[1px] hover:shadow-[1px_1px_0_0_#000] hover:bg-primary active:translate-x-[2px] active:translate-y-[2px] active:shadow-none"
	>
		<svg
			class="w-4 h-4"
			fill="none"
			stroke="currentColor"
			viewBox="0 0 24 24"
			stroke-width="2.5"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
			></path>
		</svg>
		{user && (
			<span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-green-500 border-2 border-border"></span>
		)}
	</DropdownTrigger>
	<DropdownContent>
		{
			user !== null ? (
				<>
					<DropdownLabel class="text-xs font-bold truncate max-w-[180px]">
						{user?.phone}
					</DropdownLabel>
					<DropdownItem as="a" href="/profile" class="flex items-center gap-2 text-sm">
						<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
						</svg>
						<span>Миний профайл</span>
					</DropdownItem>
					<DropdownItem as="a" href="/orders" class="flex items-center gap-2 text-sm">
						<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
						</svg>
						<span>Захиалгууд</span>
					</DropdownItem>
					<LogoutButton client:visible />
				</>
			) : (
				<>
					<DropdownLabel class="text-xs">Нэвтрэх</DropdownLabel>
					<DropdownItem as="a" href="/login" class="flex items-center gap-2 text-sm">
						<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
						</svg>
						<span>Нэвтрэх</span>
					</DropdownItem>
					<DropdownItem as="a" href="/register" class="flex items-center gap-2 text-sm">
						<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
						</svg>
						<span>Бүртгүүлэх</span>
					</DropdownItem>
				</>
			)
		}
	</DropdownContent>
</Dropdown>
