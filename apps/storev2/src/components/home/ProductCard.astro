---
import { formatCurrency } from "@vit/shared/utils";
import { productColors } from "@/lib/constant";
import type { ProductForHome } from "@/lib/types";
import AddToCartButton from "../cart/add-to-cart-button.tsx";

interface Props {
    product: ProductForHome;
    badgeStyle?: "featured" | "new" | "discount";
}

const { product: p } = Astro.props;

const randomColor =
    productColors[Math.floor(Math.random() * productColors.length)];
---

<div
    class="group relative flex flex-col bg-card border-2 border-border shadow-hard hover:shadow-hard-lg hover:-translate-y-1 transition-all duration-300"
    aria-label={`${p.name} by ${p.brand}`}
>
    <!-- Card Header / Image -->
    <a href={`/products/${p.slug}-${p.id}`} class="relative block border-b-2 border-border overflow-hidden bg-muted/20">
        <div class="aspect-[4/5] p-6 flex items-center justify-center relative">
            <!-- Background Pattern -->
            <div class="absolute inset-0 bg-dots-pattern opacity-30"></div>
            
            <!-- Brand Tag -->
            <div class="absolute top-3 left-3 z-10">
                <span class="bg-background border-2 border-border px-2 py-1 text-xs font-bold uppercase shadow-hard-sm">
                    {p.brand}
                </span>
            </div>

            <!-- Product Image -->
            <img
                src={p.image}
                alt={p.name}
                class="relative z-10 w-full h-full object-contain group-hover:scale-110 transition-transform duration-500 drop-shadow-md"
                loading="lazy"
                transition:name={`product-image-${p.id}`}
            />
        </div>
    </a>

    <!-- Card Body -->
    <div class="flex flex-col flex-1 p-4 gap-4">
        <a href={`/products/${p.slug}-${p.id}`} class="block">
            <h3 
                class="font-bold text-lg leading-tight line-clamp-2 group-hover:text-primary transition-colors"
                transition:name={`product-name-${p.id}`}
            >
                {p.name}
            </h3>
        </a>

        <!-- Stats / Tags (Mocked for visual style) -->
        <div class="flex gap-2 text-[10px] font-mono uppercase text-muted-foreground">
            <span class="border border-border px-1 bg-muted/30">Energy</span>
            <span class="border border-border px-1 bg-muted/30">Focus</span>
        </div>

        <div class="mt-auto flex items-end justify-between gap-4">
            <div class="flex flex-col">
                {p.discount && (
                    <span class="text-xs text-muted-foreground line-through decoration-2 decoration-destructive">
                        {formatCurrency(p.price * (1 - p.discount / 100))}
                    </span>
                )}
                <span 
                    class="text-2xl font-black tracking-tight"
                    transition:name={`product-price-${p.id}`}
                >
                    {formatCurrency(p.price)}
                </span>
            </div>
        </div>
    </div>

    <!-- Detached Action Button -->
    <div class="p-4 pt-0">
        <div transition:name={`product-add-to-cart-button-${p.id}`}>
            <AddToCartButton
                client:load
                cartItem={{
                    productId: p.id,
                    quantity: 1,
                    name: p.name,
                    price: p.price,
                    image: p.image,
                }}
            >
                <button 
                    slot="fallback"
                    disabled
                    class="w-full bg-primary text-primary-foreground border-2 border-border font-bold py-3 uppercase tracking-wider shadow-hard-sm opacity-50"
                >
                    Loading...
                </button>
            </AddToCartButton>
        </div>
    </div>
</div>
