---







import AddToCartButton from "@/components/cart/add-to-cart-button";
import { productColors } from "@/lib/constant";
import { toProductImageUrl } from "@/lib/image";
import type { ProductForHome } from "@/lib/types";
import { formatCurrency } from "@/lib/utils";

interface Props {
    product: ProductForHome;
    badgeStyle?: "featured" | "new" | "discount";
    sectionId?: string;
    index?: number;
}

const { product: p, sectionId = "", index = 0 } = Astro.props;
const uniqueId = sectionId ? `${sectionId}-${index}` : `card-${index}`;
const bgColor = productColors[p.id % productColors.length];
const productUrl = `/products/${p.slug}-${p.id}`;
const productImageSmall = toProductImageUrl(p.image, "sm") || p.image;
---

<div
    class="group relative flex flex-col border-2 border-black bg-white shadow-[3px_3px_0_0_#000] transition-all duration-200 hover:-translate-y-0.5 hover:shadow-[4px_4px_0_0_#000] sm:border-3 sm:shadow-[5px_5px_0_0_#000] sm:hover:shadow-[6px_6px_0_0_#000]"
    data-product-id={p.id}
>
    <!-- Image Section -->
    <a
        href={productUrl}
        class="relative block overflow-hidden border-black border-b-2 sm:border-b-3"
        aria-label={`${p.name}${p.brand ? ` by ${p.brand}` : ""}`}
    >
        <div
            class="relative aspect-[4/5] sm:aspect-[4/3]"
            style={`background: ${bgColor}`}
        >
            <!-- Dot Pattern Overlay -->
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(0,0,0,0.07)_2px,transparent_0)] bg-[length:14px_14px]"></div>

            <!-- Product Image -->
            {p.image && (
                <img
                    src={productImageSmall}
                    alt={p.name}
                    class="absolute inset-0 h-full w-full object-contain p-3 transition-transform duration-300 group-hover:scale-105 sm:p-4"
                    width="400"
                    height="500"
                    loading="lazy"
                    transition:name={`product-image-${p.id}-${uniqueId}`}
                />
            )}

            <!-- Brand Badge -->
            {p.brand && (
                <div class="absolute right-1.5 bottom-1.5 rounded-sm border-2 border-black bg-white px-1.5 py-0.5 font-black text-[8px] uppercase tracking-tight shadow-[2px_2px_0_0_#000] sm:right-3 sm:bottom-3 sm:px-2.5 sm:py-1 sm:text-[10px]">
                    {p.brand}
                </div>
            )}
        </div>
    </a>

    <!-- Content Section -->
    <div class="flex flex-1 flex-col p-2 sm:p-3">
        <a href={productUrl} class="block">
            <h3 
                class="line-clamp-2 font-bold text-[11px] leading-tight tracking-tight group-hover:underline sm:text-sm sm:leading-snug"
                transition:name={`product-name-${p.id}-${uniqueId}`}
            >
                {p.name}
            </h3>
        </a>
    </div>

    <!-- Price & CTA Bar -->
    <div class="flex items-center justify-between gap-1.5 border-black border-t-2 bg-primary/10 px-2 py-1.5 sm:gap-2 sm:border-t-3 sm:px-3 sm:py-2">
        <div 
            class="font-black text-sm tracking-tight sm:text-lg"
            transition:name={`product-price-${p.id}-${uniqueId}`}
        >
            {formatCurrency(p.price)}
        </div>
        <AddToCartButton
            client:load
            compact
            cartItem={{
                productId: p.id,
                quantity: 1,
                name: p.name,
                price: p.price,
                image: p.image,
            }}
        />
    </div>
</div>
